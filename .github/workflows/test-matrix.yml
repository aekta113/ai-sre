name: Multi-Platform Testing

on:
  pull_request:
    branches: [ master, main ]
  push:
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  test-matrix:
    name: Test on ${{ matrix.os }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        arch: [amd64, arm64]
        exclude:
          - os: macos-latest
            arch: arm64  # GitHub doesn't support ARM64 macOS runners yet
          - os: macos-latest
            arch: amd64  # Docker not available on macOS runners
            
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        docker buildx build --platform linux/${{ matrix.arch }} -t ai-sre:test-${{ matrix.arch }} --load .
        
    - name: Test container startup
      run: |
        docker run -d --name ai-sre-test-${{ matrix.arch }} -p 8080:8080 ai-sre:test-${{ matrix.arch }}
        sleep 10
        
    - name: Test MCP Server endpoints
      run: |
        curl -f http://localhost:8080/health || exit 1
        curl -f http://localhost:8080/ready || exit 1
        curl -f http://localhost:8080/version || exit 1
        
    - name: Test new API endpoints
      run: |
        # Wait a bit more for container to be fully ready
        sleep 5
        
        # Test CLI tools endpoint
        response=$(curl -s http://localhost:8080/cli/tools)
        echo "CLI tools response: $response"
        echo "$response" | grep -q "active_tools" || echo "Warning: CLI tools endpoint may have issues"
        
        # Test configuration endpoint
        response=$(curl -s http://localhost:8080/config)
        echo "Config response: $response"
        echo "$response" | grep -q "configuration" || echo "Warning: Config endpoint may have issues"
        
        # Test runbook health endpoint
        response=$(curl -s http://localhost:8080/runbooks/health)
        echo "Runbook health response: $response"
        echo "$response" | grep -q "status" || echo "Warning: Runbook health endpoint may have issues"
        
        # Test storage usage endpoint
        response=$(curl -s http://localhost:8080/storage/usage)
        echo "Storage usage response: $response"
        echo "$response" | grep -q "storage_usage" || echo "Warning: Storage usage endpoint may have issues"
        
        # Test environment endpoint
        response=$(curl -s http://localhost:8080/env)
        echo "Environment response: $response"
        echo "$response" | grep -q "environment_variables" || echo "Warning: Environment endpoint may have issues"
        
    - name: Test kubectl functionality
      run: |
        # Test kubectl version (should work even without cluster)
        response=$(curl -s -X POST http://localhost:8080/kubectl/version \
          -H "Content-Type: application/json" \
          -d '{}')
        echo "Kubectl response: $response"
        # Check if response contains kubectl version info (success or expected error)
        echo "$response" | grep -q "kubectl" || echo "Warning: kubectl test may have failed"
          
    - name: Test git functionality
      run: |
        # Test git status (may fail in container without git repo - this is expected)
        response=$(curl -s -X POST http://localhost:8080/git/status \
          -H "Content-Type: application/json" \
          -d '{}')
        echo "Git response: $response"
        # Check if response contains git error (expected in container)
        echo "$response" | grep -q "git" || echo "Warning: git test may have failed"
          
    - name: Test flux functionality
      run: |
        # Test flux version
        response=$(curl -s -X POST http://localhost:8080/flux/version \
          -H "Content-Type: application/json" \
          -d '{}')
        echo "Flux response: $response"
        # Check if response contains flux version info
        echo "$response" | grep -q "flux" || echo "Warning: flux test may have failed"
          
    - name: Verify CLI tools
      run: |
        docker exec ai-sre-test-${{ matrix.arch }} kubectl version --client
        docker exec ai-sre-test-${{ matrix.arch }} helm version --client
        docker exec ai-sre-test-${{ matrix.arch }} flux version --client
        docker exec ai-sre-test-${{ matrix.arch }} git --version
        
    - name: Check container stats
      run: |
        docker stats --no-stream ai-sre-test-${{ matrix.arch }}
        
    - name: Cleanup
      if: always()
      run: |
        docker stop ai-sre-test-${{ matrix.arch }} || true
        docker rm ai-sre-test-${{ matrix.arch }} || true
